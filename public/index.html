<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Agent Orchestrator</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #f5f5f5;
      color: #333;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px;
    }
    
    header {
      background: white;
      padding: 24px;
      border-radius: 8px;
      margin-bottom: 24px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    h1 { font-size: 28px; margin-bottom: 8px; }
    .subtitle { color: #666; font-size: 14px; }
    
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }
    
    .stat-card {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .stat-value {
      font-size: 32px;
      font-weight: 600;
      color: #2563eb;
      margin-bottom: 4px;
    }
    
    .stat-label {
      font-size: 14px;
      color: #666;
    }
    
    .section {
      background: white;
      padding: 24px;
      border-radius: 8px;
      margin-bottom: 24px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    
    h2 { font-size: 20px; }
    
    .btn {
      background: #2563eb;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: background 0.2s;
    }
    
    .btn:hover { background: #1d4ed8; }
    .btn-secondary {
      background: #6b7280;
    }
    .btn-secondary:hover { background: #4b5563; }
    
    .empty-state {
      text-align: center;
      padding: 40px;
      color: #666;
    }
    
    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.5;
    }
    
    .list-item {
      padding: 16px;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .list-item:last-child { border-bottom: none; }
    
    .list-item-title {
      font-weight: 500;
      margin-bottom: 4px;
    }
    
    .list-item-meta {
      font-size: 12px;
      color: #666;
    }
    
    .badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 500;
    }
    
    .badge-success { background: #dcfce7; color: #166534; }
    .badge-error { background: #fee2e2; color: #991b1b; }
    .badge-pending { background: #fef3c7; color: #92400e; }
    
    .login-form {
      max-width: 400px;
      margin: 100px auto;
      background: white;
      padding: 32px;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .form-group {
      margin-bottom: 16px;
    }
    
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      font-size: 14px;
    }
    
    input {
      width: 100%;
      padding: 10px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 14px;
    }
    
    input:focus {
      outline: none;
      border-color: #2563eb;
    }
    
    .hidden { display: none; }
    
    .toast {
      position: fixed;
      top: 24px;
      right: 24px;
      background: white;
      padding: 16px 24px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 1000;
      animation: slideIn 0.3s ease;
    }
    
    .toast.error { border-left: 4px solid #ef4444; }
    .toast.success { border-left: 4px solid #10b981; }
    
    @keyframes slideIn {
      from { transform: translateX(400px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }
    
    .modal-content {
      background: white;
      padding: 24px;
      border-radius: 12px;
      max-width: 500px;
      width: 90%;
    }
    
    .modal-content h2 {
      margin-bottom: 16px;
    }
  </style>
</head>
<body>
  <!-- Login Screen -->
  <div id="loginScreen" class="login-form">
    <h1 style="margin-bottom: 24px;">Agent Orchestrator</h1>
    <div id="loginView">
      <div class="form-group">
        <label>Email</label>
        <input type="email" id="loginEmail" placeholder="you@example.com">
      </div>
      <div class="form-group">
        <label>Password</label>
        <input type="password" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
      </div>
      <button class="btn" style="width: 100%;" onclick="login()">Login</button>
      <p style="margin-top: 16px; text-align: center; font-size: 14px; color: #666;">
        Don't have an account? <a href="#" onclick="showSignupForm(); return false;" style="color: #2563eb;">Sign up</a>
      </p>
    </div>
    
    <div id="signupView" class="hidden">
      <div class="form-group">
        <label>Workspace Name</label>
        <input type="text" id="signupName" placeholder="My Workspace">
      </div>
      <div class="form-group">
        <label>Email</label>
        <input type="email" id="signupEmail" placeholder="you@example.com">
      </div>
      <div class="form-group">
        <label>Password</label>
        <input type="password" id="signupPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
      </div>
      <button class="btn" style="width: 100%;" onclick="signup()">Create Account</button>
      <p style="margin-top: 16px; text-align: center; font-size: 14px; color: #666;">
        <a href="#" onclick="showLoginForm(); return false;" style="color: #2563eb;">‚Üê Back to login</a>
      </p>
    </div>
  </div>

  <!-- Dashboard -->
  <div id="dashboard" class="hidden">
    <div class="container">
      <div id="usageWarning" class="hidden" style="background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; padding: 16px; margin-bottom: 24px;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <strong>‚ö†Ô∏è Usage Warning:</strong> <span id="warningText"></span>
        </div>
        <div style="display: flex; gap: 8px;">
          <a href="/pricing.html" class="btn" style="padding: 8px 16px; font-size: 14px;">Upgrade</a>
          <button onclick="dismissWarning()" class="btn btn-secondary" style="padding: 8px 16px; font-size: 14px;">Dismiss</button>
        </div>
      </div>
      
      <header>
        <h1>Agent Orchestrator</h1>
        <p class="subtitle">
          <a href="#" onclick="showDashboard(); return false;" style="color: #2563eb;">Home</a> | 
          Workspace: <span id="workspaceName"></span> | 
          <a href="/docs.html" style="color: #2563eb;">Docs</a> | 
          <a href="#" onclick="showSettings(); return false;" style="color: #2563eb;">Settings</a> | 
          <a href="#" onclick="logout(); return false;" style="color: #ef4444;">Logout</a>
        </p>
      </header>
      
      <div class="stats">
        <div class="stat-card">
          <div class="stat-value" id="agentCount">0</div>
          <div class="stat-label">Agents</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="runCount">0</div>
          <div class="stat-label">Total Runs</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="runsThisMonth">0</div>
          <div class="stat-label">Runs This Month</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="stepsThisMonth">0</div>
          <div class="stat-label">Steps This Month</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="httpCallsThisMonth">0</div>
          <div class="stat-label">HTTP Calls</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="executionHours">0</div>
          <div class="stat-label">Execution Hours</div>
        </div>
      </div>
      
      <div class="section">
        <div class="section-header">
          <h2>Quick Start</h2>
        </div>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px;">
          <div style="padding: 16px; border: 2px dashed #d1d5db; border-radius: 8px; text-align: center;">
            <div style="font-size: 32px; margin-bottom: 8px;">ü§ñ</div>
            <div style="font-weight: 500; margin-bottom: 4px;">Create Agent</div>
            <div style="font-size: 12px; color: #666; margin-bottom: 12px;">Build automated workflows</div>
            <button class="btn" onclick="showAgentBuilder()">Get Started</button>
          </div>
          
          <div style="padding: 16px; border: 2px dashed #d1d5db; border-radius: 8px; text-align: center;">
            <div style="font-size: 32px; margin-bottom: 8px;">üìä</div>
            <div style="font-weight: 500; margin-bottom: 4px;">View Runs</div>
            <div style="font-size: 12px; color: #666; margin-bottom: 12px;">Monitor execution history</div>
            <button class="btn btn-secondary" onclick="showRuns()">View History</button>
          </div>
        </div>
      </div>
      
      <div class="section">
        <div class="section-header">
          <h2>Available Tools</h2>
        </div>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px;">
          <div style="padding: 12px; background: #f9fafb; border-radius: 6px; text-align: center;">
            <div style="font-size: 24px; margin-bottom: 4px;">üåê</div>
            <div style="font-size: 14px; font-weight: 500;">HTTP</div>
          </div>
          <div style="padding: 12px; background: #f9fafb; border-radius: 6px; text-align: center;">
            <div style="font-size: 24px; margin-bottom: 4px;">üîî</div>
            <div style="font-size: 14px; font-weight: 500;">Webhook</div>
          </div>
          <div style="padding: 12px; background: #f9fafb; border-radius: 6px; text-align: center;">
            <div style="font-size: 24px; margin-bottom: 4px;">‚è±Ô∏è</div>
            <div style="font-size: 14px; font-weight: 500;">Delay</div>
          </div>
          <div style="padding: 12px; background: #f9fafb; border-radius: 6px; text-align: center;">
            <div style="font-size: 24px; margin-bottom: 4px;">üîÄ</div>
            <div style="font-size: 14px; font-weight: 500;">Conditional</div>
          </div>
          <div style="padding: 12px; background: #f9fafb; border-radius: 6px; text-align: center;">
            <div style="font-size: 24px; margin-bottom: 4px;">üîÑ</div>
            <div style="font-size: 14px; font-weight: 500;">Transform</div>
          </div>
          <div style="padding: 12px; background: #f9fafb; border-radius: 6px; text-align: center;">
            <div style="font-size: 24px; margin-bottom: 4px;">üíæ</div>
            <div style="font-size: 14px; font-weight: 500;">Database</div>
          </div>
          <div style="padding: 12px; background: #f9fafb; border-radius: 6px; text-align: center;">
            <div style="font-size: 24px; margin-bottom: 4px;">üìß</div>
            <div style="font-size: 14px; font-weight: 500;">SMTP</div>
          </div>
          <div style="padding: 12px; background: #f9fafb; border-radius: 6px; text-align: center;">
            <div style="font-size: 24px; margin-bottom: 4px;">‚è∞</div>
            <div style="font-size: 14px; font-weight: 500;">Schedule</div>
          </div>
        </div>
      </div>
      
      <div class="section">
        <div class="section-header">
          <h2>My Agents</h2>
        </div>
        <div id="agentsList"></div>
      </div>
    </div>
  </div>

  <!-- Agent Builder -->
  <div id="agentBuilder" class="hidden">
    <div class="container">
      <header>
        <h1>Create Agent</h1>
        <button class="btn btn-secondary" onclick="showDashboard()">‚Üê Back</button>
      </header>
      
      <div class="section">
        <div class="form-group">
          <label>Agent Name</label>
          <input type="text" id="agentName" placeholder="My Agent">
        </div>
        
        <div class="form-group">
          <label>Trigger Type</label>
          <select id="triggerType" onchange="updateTriggerInputs()" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;">
            <option value="cron">Cron Schedule</option>
            <option value="webhook">Webhook</option>
            <option value="email">Email</option>
            <option value="sms">SMS</option>
            <option value="calendar">Calendar</option>
          </select>
        </div>
        
        <div id="triggerInputs"></div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 16px;">
          <div class="form-group">
            <label>Max Retries</label>
            <input type="number" id="maxRetries" value="3" min="0" max="10" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;">
          </div>
          <div class="form-group">
            <label>Timeout (seconds)</label>
            <input type="number" id="timeoutSeconds" value="300" min="10" max="3600" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;">
          </div>
        </div>
        
        <div style="margin: 16px 0; padding: 12px; background: #f9fafb; border-radius: 6px;">
          <label style="display: block; margin-bottom: 8px; font-size: 14px;">Add from Template</label>
          <select id="templateSelect" onchange="loadTemplate(this.value)" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;">
            <option value="">Choose a template...</option>
          </select>
        </div>
        
        <h3 style="margin: 24px 0 16px;">Tools</h3>
        <div id="toolsList"></div>
        
        <button class="btn btn-secondary" onclick="addTool()" style="margin-top: 16px;">+ Add Tool</button>
        
        <div style="margin-top: 32px; padding-top: 24px; border-top: 1px solid #e5e7eb;">
          <button class="btn" onclick="createAgent()">Create Agent</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Run History -->
  <div id="runHistory" class="hidden">
    <div class="container">
      <header style="display: flex; justify-content: space-between; align-items: center;">
        <h1>Run History</h1>
        <div>
          <button class="btn btn-secondary" onclick="showRuns()">üîÑ Refresh</button>
          <button class="btn btn-secondary" onclick="showDashboard()">‚Üê Back</button>
        </div>
      </header>
      
      <div class="section">
        <div id="runsList"></div>
      </div>
    </div>
  </div>

  <!-- Run Details -->
  <div id="runDetails" class="hidden">
    <div class="container">
      <header style="display: flex; justify-content: space-between; align-items: center;">
        <h1>Run Details</h1>
        <div>
          <button class="btn btn-secondary" onclick="refreshRunDetails()">üîÑ Refresh</button>
          <button class="btn btn-secondary" onclick="showRuns()">‚Üê Back</button>
        </div>
      </header>
      
      <div class="section">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px;">
          <div>
            <div style="font-size: 12px; color: #666; margin-bottom: 4px;">Status</div>
            <div id="detailStatus"></div>
          </div>
          <div>
            <div style="font-size: 12px; color: #666; margin-bottom: 4px;">Agent</div>
            <div id="detailAgent"></div>
          </div>
          <div>
            <div style="font-size: 12px; color: #666; margin-bottom: 4px;">Started</div>
            <div id="detailStarted"></div>
          </div>
          <div>
            <div style="font-size: 12px; color: #666; margin-bottom: 4px;">Duration</div>
            <div id="detailDuration"></div>
          </div>
        </div>
        
        <h3 style="margin-bottom: 16px;">Execution Log</h3>
        <div id="detailLog" style="background: #1e1e1e; color: #d4d4d4; padding: 16px; border-radius: 6px; font-family: monospace; font-size: 12px; white-space: pre-wrap; max-height: 600px; overflow-y: auto;"></div>
      </div>
    </div>
  </div>

  <!-- Settings -->
  <div id="settings" class="hidden">
    <div class="container">
      <header>
        <h1>Settings</h1>
        <button class="btn btn-secondary" onclick="showDashboard()">‚Üê Back</button>
      </header>
      
      <div class="section">
        <h2 style="margin-bottom: 16px;">Workspace</h2>
        
        <div class="form-group">
          <label>API Key</label>
          <div style="display: flex; gap: 8px;">
            <input type="password" id="workspaceApiKey" readonly style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; background: #f9fafb;">
            <button class="btn btn-secondary" onclick="toggleApiKey()" style="white-space: nowrap;">Show</button>
          </div>
          <p style="font-size: 12px; color: #666; margin-top: 4px;">Use this key for API access and CLI tools.</p>
        </div>
      </div>
      
      <div class="section">
        <h2 style="margin-bottom: 16px;">API Keys</h2>
        
        <div class="form-group">
          <label>LLM API Key</label>
          <input type="password" id="llmKey" placeholder="sk-..." style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;">
          <p style="font-size: 12px; color: #666; margin-top: 4px;">Used for LLM tools across all agents. Supports OpenAI and Anthropic. Get keys from <a href="https://platform.openai.com/api-keys" target="_blank" style="color: #2563eb;">OpenAI</a> or <a href="https://console.anthropic.com/settings/keys" target="_blank" style="color: #2563eb;">Anthropic</a>.</p>
        </div>
        
        <div class="form-group">
          <label>SendGrid API Key</label>
          <input type="password" id="sendgridKey" placeholder="SG...." style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;">
          <p style="font-size: 12px; color: #666; margin-top: 4px;">Used for SendGrid email tools across all agents. Get your key from <a href="https://app.sendgrid.com/settings/api_keys" target="_blank" style="color: #2563eb;">SendGrid</a>.</p>
        </div>
        
        <div class="form-group">
          <label>Twilio Account SID</label>
          <input type="password" id="twilioSid" placeholder="AC..." style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;">
        </div>
        
        <div class="form-group">
          <label>Twilio Auth Token</label>
          <input type="password" id="twilioToken" placeholder="..." style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;">
          <p style="font-size: 12px; color: #666; margin-top: 4px;">Used for Twilio SMS tools across all agents. Get credentials from <a href="https://console.twilio.com/" target="_blank" style="color: #2563eb;">Twilio Console</a>.</p>
        </div>
        
        <button class="btn" onclick="saveSettings()">Save Settings</button>
      </div>
    </div>
  </div>

  <script>
    const API_URL = window.location.origin;
    let apiKey = localStorage.getItem('apiKey');
    let workspace = null;
    let tools = [];
    let currentRuns = [];
    let currentWorkspace = null;
    let currentRunId = null;
    let refreshTimer = null;
    
    function showToast(message, type = 'error') {
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 10000);
    }
    
    function logout() {
      localStorage.removeItem('apiKey');
      localStorage.removeItem('token');
      sessionStorage.clear();
      apiKey = null;
      currentWorkspace = null;
      
      // Clear all form fields
      document.getElementById('loginEmail').value = '';
      document.getElementById('loginPassword').value = '';
      document.getElementById('signupName').value = '';
      document.getElementById('signupEmail').value = '';
      document.getElementById('signupPassword').value = '';
      
      hideAll();
      document.getElementById('loginScreen').classList.remove('hidden');
      showLoginForm(); // Ensure login view is shown, not signup
      showToast('Logged out', 'success');
    }
    
    function checkUsageWarning(workspace) {
      const dismissed = sessionStorage.getItem('usageWarningDismissed');
      if (dismissed) return;
      
      const plan = workspace?.plan || 'free';
      const limits = {
        free: 200,
        starter: 5000,
        pro: 50000,
        enterprise: -1
      };
      
      const limit = limits[plan];
      if (limit === -1) return; // unlimited
      
      const usage = workspace?.runs_this_month || 0;
      const percent = (usage / limit) * 100;
      
      console.log('Usage check:', { usage, limit, percent }); // Debug
      
      if (percent >= 80) {
        const remaining = limit - usage;
        document.getElementById('warningText').textContent = 
          `You've used ${usage} of ${limit} runs this month (${percent.toFixed(0)}%). ${remaining} runs remaining.`;
        document.getElementById('usageWarning').classList.remove('hidden');
      }
    }
    
    function dismissWarning() {
      document.getElementById('usageWarning').classList.add('hidden');
      sessionStorage.setItem('usageWarningDismissed', 'true');
    }
    
    async function login() {
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;
      
      if (!email || !password) return showToast('Email and password required');
      
      try {
        const res = await fetch(`${API_URL}/v1/auth/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });
        
        if (!res.ok) {
          const error = await res.json();
          throw new Error(error.error || 'Login failed');
        }
        
        const data = await res.json();
        apiKey = data.api_key;
        localStorage.setItem('apiKey', apiKey);
        localStorage.setItem('token', data.token);
        loadDashboard();
      } catch (err) {
        showToast('Error: ' + err.message);
      }
    }
    
    function showLoginForm() {
      document.getElementById('loginView').classList.remove('hidden');
      document.getElementById('signupView').classList.add('hidden');
    }
    
    function showSignupForm() {
      document.getElementById('loginView').classList.add('hidden');
      document.getElementById('signupView').classList.remove('hidden');
    }
    
    async function signup() {
      const name = document.getElementById('signupName').value;
      const email = document.getElementById('signupEmail').value;
      const password = document.getElementById('signupPassword').value;
      
      if (!name || !email || !password) return showToast('All fields required');
      
      try {
        const res = await fetch(`${API_URL}/v1/auth/signup`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, email, password })
        });
        
        if (!res.ok) {
          const error = await res.json();
          throw new Error(error.error || 'Signup failed');
        }
        
        const data = await res.json();
        apiKey = data.api_key;
        localStorage.setItem('apiKey', apiKey);
        localStorage.setItem('token', data.token);
        showToast('Account created!', 'success');
        loadDashboard();
      } catch (err) {
        showToast('Error: ' + err.message);
      }
    }
    
    async function loadDashboard() {
      try {
        const res = await fetch(`${API_URL}/v1/agents`, {
          headers: { 'Authorization': `Bearer ${apiKey}` }
        });
        
        if (res.status === 401) {
          localStorage.removeItem('apiKey');
          apiKey = null;
          hideAll();
          document.getElementById('loginScreen').classList.remove('hidden');
          showToast('Invalid API key - please login again');
          return;
        }
        
        const agents = await res.json();
        
        const wsRes = await fetch(`${API_URL}/v1/workspace`, {
          headers: { 'Authorization': `Bearer ${apiKey}` }
        });
        currentWorkspace = await wsRes.json();
        
        const runsRes = await fetch(`${API_URL}/v1/runs`, {
          headers: { 'Authorization': `Bearer ${apiKey}` }
        });
        const runs = await runsRes.json();
        
        const schedulesRes = await fetch(`${API_URL}/v1/schedules`, {
          headers: { 'Authorization': `Bearer ${apiKey}` }
        });
        const schedules = await schedulesRes.json();
        
        hideAll();
        document.getElementById('dashboard').classList.remove('hidden');
        
        document.getElementById('agentCount').textContent = agents.length;
        document.getElementById('runCount').textContent = runs.length;
        document.getElementById('runsThisMonth').textContent = currentWorkspace?.runs_this_month || 0;
        document.getElementById('stepsThisMonth').textContent = currentWorkspace?.steps_this_month || 0;
        document.getElementById('httpCallsThisMonth').textContent = currentWorkspace?.http_calls_this_month || 0;
        document.getElementById('executionHours').textContent = ((currentWorkspace?.execution_seconds_this_month || 0) / 3600).toFixed(2);
        
        // Check usage and show warning
        checkUsageWarning(currentWorkspace);
        
        renderAgentsList(agents);
        
      } catch (err) {
        showToast('Error loading dashboard: ' + err.message);
      }
    }
    
    function renderAgentsList(agents) {
      const container = document.getElementById('agentsList');
      if (agents.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ü§ñ</div><div>No agents yet. Create one to get started!</div></div>';
        return;
      }
      
      container.innerHTML = agents.map(agent => `
        <div class="list-item">
          <div>
            <div class="list-item-title">${agent.name}</div>
            <div class="list-item-meta">${agent.steps?.length || 0} tool(s)</div>
          </div>
          <div style="display: flex; gap: 8px;">
            <button class="btn" onclick="runAgent('${agent.agent_id}', '${agent.project_id}')">‚ñ∂ Run</button>
            <button class="btn btn-secondary" onclick="showWebhook('${agent.agent_id}', '${agent.project_id}')">üîó Triggers</button>
            <button class="btn btn-secondary" onclick="editAgent('${agent.agent_id}')">‚úèÔ∏è Edit</button>
            <button class="btn btn-secondary" onclick="cloneAgent('${agent.agent_id}')">üìã Clone</button>
            <button class="btn btn-secondary" onclick="deleteAgent('${agent.agent_id}')" style="background: #ef4444;">Delete</button>
          </div>
        </div>
      `).join('');
    }
    
    async function deleteAgent(agentId) {
      if (!confirm('Delete this agent?')) return;
      
      try {
        const res = await fetch(`${API_URL}/v1/agents/${agentId}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${apiKey}` }
        });
        
        if (!res.ok) throw new Error(await res.text());
        
        showToast('Agent deleted!', 'success');
        loadDashboard();
      } catch (err) {
        showToast('Error: ' + err.message);
      }
    }
    
    async function cloneAgent(agentId) {
      try {
        const res = await fetch(`${API_URL}/v1/agents/${agentId}`, {
          headers: { 'Authorization': `Bearer ${apiKey}` }
        });
        const agent = await res.json();
        
        // Open agent builder with cloned data
        showAgentBuilder();
        document.getElementById('agentName').value = agent.name + ' (Copy)';
        document.getElementById('maxRetries').value = agent.retry_policy?.max_attempts || 3;
        document.getElementById('timeoutSeconds').value = agent.timeout_seconds || 300;
        tools = JSON.parse(JSON.stringify(agent.steps)); // Deep clone
        renderTools();
        
        showToast('Agent cloned! Edit and save.', 'success');
      } catch (err) {
        showToast('Error: ' + err.message);
      }
    }
    
    async function editAgent(agentId) {
      try {
        const res = await fetch(`${API_URL}/v1/agents/${agentId}`, {
          headers: { 'Authorization': `Bearer ${apiKey}` }
        });
        const agent = await res.json();
        
        // Open agent builder with existing data
        showAgentBuilder();
        document.getElementById('agentName').value = agent.name;
        document.getElementById('maxRetries').value = agent.retry_policy?.max_attempts || 3;
        document.getElementById('timeoutSeconds').value = agent.timeout_seconds || 300;
        tools = JSON.parse(JSON.stringify(agent.steps));
        renderTools();
        
        // Store agent ID for update
        window.editingAgentId = agentId;
        
        // Change button text
        document.querySelector('#agentBuilder button[onclick="createAgent()"]').textContent = 'Update Agent';
        
        showToast('Editing agent', 'success');
      } catch (err) {
        showToast('Error: ' + err.message);
      }
    }
    
    function showWebhook(agentId, projectId) {
      const webhookUrl = `${API_URL}/v1/runs`;
      const emailAddress = `agent-${agentId}@${window.location.hostname}`;
      
      const curlExample = `curl -X POST ${webhookUrl} \\
  -H "Authorization: Bearer ${apiKey}" \\
  -H "Content-Type: application/json" \\
  -d '{
    "agent_id": "${agentId}",
    "project_id": "${projectId}",
    "input": {
      "key": "value"
    }
  }'`;
      
      const message = `
        <div style="text-align: left;">
          <h3 style="margin-bottom: 12px;">Webhook URL</h3>
          <input type="text" value="${webhookUrl}" readonly onclick="this.select()" style="width: 100%; padding: 8px; margin-bottom: 16px; font-family: monospace; font-size: 12px; border: 1px solid #d1d5db; border-radius: 4px;">
          
          <h3 style="margin-bottom: 12px;">Email Trigger</h3>
          <input type="text" value="${emailAddress}" readonly onclick="this.select()" style="width: 100%; padding: 8px; margin-bottom: 8px; font-family: monospace; font-size: 12px; border: 1px solid #d1d5db; border-radius: 4px;">
          <p style="font-size: 11px; color: #666; margin-bottom: 16px;">Send email to this address to trigger the agent. Configure SendGrid Inbound Parse to forward to: ${API_URL}/v1/inbound/email</p>
          
          <h3 style="margin-bottom: 12px;">SMS Trigger</h3>
          <p style="font-size: 11px; color: #666; margin-bottom: 16px;">Configure Twilio webhook: ${API_URL}/v1/inbound/sms<br>Set AGENT_PHONE_MAPPINGS env var: ${agentId}:+1234567890</p>
          
          <h3 style="margin-bottom: 12px;">Calendar Trigger</h3>
          <p style="font-size: 11px; color: #666; margin-bottom: 16px;">Configure Google Calendar push notification: ${API_URL}/v1/inbound/calendar<br>Set AGENT_CALENDAR_MAPPINGS env var: ${agentId}:channelId</p>
          
          <h3 style="margin-bottom: 12px;">Example cURL</h3>
          <pre style="background: #1f2937; color: #f9fafb; padding: 12px; border-radius: 4px; overflow-x: auto; font-size: 11px; margin: 0;">${curlExample}</pre>
        </div>
      `;
      
      const overlay = document.createElement('div');
      overlay.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;';
      overlay.innerHTML = `
        <div style="background: white; padding: 24px; border-radius: 8px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
          ${message}
          <button class="btn" onclick="this.closest('div[style*=fixed]').remove()" style="margin-top: 16px; width: 100%;">Close</button>
        </div>
      `;
      document.body.appendChild(overlay);
      overlay.onclick = (e) => { if (e.target === overlay) overlay.remove(); };
    }
    
    async function runAgent(agentId, projectId) {
      try {
        const res = await fetch(`${API_URL}/v1/runs`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`
          },
          body: JSON.stringify({ agent_id: agentId, project_id: projectId, input: {} })
        });
        
        if (!res.ok) throw new Error(await res.text());
        
        const run = await res.json();
        showToast('Agent started!', 'success');
        
        // Go directly to run history
        showRuns();
      } catch (err) {
        showToast('Error: ' + err.message);
      }
    }
    
    function showDashboard() {
      document.getElementById('dashboard').classList.remove('hidden');
      document.getElementById('agentBuilder').classList.add('hidden');
    }
    
    function showAgentBuilder() {
      hideAll();
      document.getElementById('agentBuilder').classList.remove('hidden');
      tools = [];
      renderTools();
      loadTemplateList();
    }
    
    async function loadTemplateList() {
      try {
        const res = await fetch(`${API_URL}/v1/templates`);
        const templates = await res.json();
        
        const select = document.getElementById('templateSelect');
        select.innerHTML = '<option value="">Choose a template...</option>' + 
          templates.map(t => `<option value="${t.id}">${t.name} - ${t.description}</option>`).join('');
      } catch (err) {
        showToast('Error loading templates: ' + err.message);
      }
    }
    
    async function loadTemplate(id) {
      if (!id) return;
      
      try {
        const res = await fetch(`${API_URL}/v1/templates/${id}`);
        const template = await res.json();
        
        // Append template steps to existing tools
        tools.push(...template.steps);
        renderTools();
        
        // Reset dropdown
        document.getElementById('templateSelect').value = '';
        
        showToast(`Added ${template.steps.length} steps from "${template.name}"`, 'success');
      } catch (err) {
        showToast('Error: ' + err.message);
      }
    }
    
    function addTool() {
      tools.push({ type: 'http', config: getToolTemplate('http') });
      renderTools();
    }
    
    function getToolTemplate(type) {
      const templates = {
        http: { url: 'https://api.github.com/zen', method: 'GET' },
        webhook: { url: 'https://webhook.site/your-unique-url', method: 'POST', body: {} },
        delay: { seconds: 5 },
        conditional: { condition: '{{step0.status}} === 200', true_branch: [], false_branch: [] },
        transform: { operation: 'extract', path: '$.data', output_key: 'result' },
        database: { connection_string: 'postgresql://user:pass@host:5432/db', query: 'SELECT * FROM users LIMIT 10' },
        sendgrid: { from: 'you@example.com', to: 'recipient@example.com', subject: 'Test', text: 'Hello!', api_key: null },
        twilio: { from: '+1234567890', to: '+1234567890', body: 'Hello!', account_sid: null, auth_token: null },
        llm: { provider: 'openai', prompt: 'Summarize this: {{step0.data}}', model: 'gpt-4o-mini', temperature: 0.7, max_tokens: 1000, api_key: null }
      };
      return templates[type] || {};
    }
    
    function removeTool(index) {
      tools.splice(index, 1);
      renderTools();
    }
    
    function updateTriggerInputs() {
      const type = document.getElementById('triggerType').value;
      const container = document.getElementById('triggerInputs');
      
      const inputs = {
        cron: '<div class="form-group"><label>Cron Expression</label><input type="text" id="cronExpression" placeholder="0 9 * * *"></div>',
        webhook: '<div class="form-group"><label>Webhook URL</label><input type="text" id="webhookUrl" placeholder="https://your-domain.com/v1/runs"></div>',
        email: '<div class="form-group"><label>Email Address</label><input type="text" id="emailAddress" placeholder="agent-{agentId}@yourdomain.com"></div>',
        sms: '<div class="form-group"><label>Phone Number</label><input type="text" id="smsPhone" placeholder="+1234567890"></div>',
        calendar: '<div class="form-group"><label>Calendar Channel ID</label><input type="text" id="calendarId" placeholder="channel-id-from-google"></div>'
      };
      
      container.innerHTML = inputs[type] || '';
    }

    function toggleCronInput() {}
    
    function renderTools() {
      const container = document.getElementById('toolsList');
      if (tools.length === 0) {
        container.innerHTML = '<div style="color: #666; padding: 16px; text-align: center;">No tools added yet</div>';
        return;
      }
      
      container.innerHTML = tools.map((tool, i) => `
        <div style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px; margin-bottom: 16px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
            <select onchange="tools[${i}].type = this.value; tools[${i}].config = getToolTemplate(this.value); renderTools();" style="padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;">
              <option value="http" ${tool.type === 'http' ? 'selected' : ''}>HTTP</option>
              <option value="webhook" ${tool.type === 'webhook' ? 'selected' : ''}>Webhook</option>
              <option value="delay" ${tool.type === 'delay' ? 'selected' : ''}>Delay</option>
              <option value="conditional" ${tool.type === 'conditional' ? 'selected' : ''}>Conditional</option>
              <option value="transform" ${tool.type === 'transform' ? 'selected' : ''}>Transform</option>
              <option value="database" ${tool.type === 'database' ? 'selected' : ''}>Database</option>
              <option value="sendgrid" ${tool.type === 'sendgrid' ? 'selected' : ''}>SendGrid</option>
              <option value="twilio" ${tool.type === 'twilio' ? 'selected' : ''}>Twilio</option>
              <option value="llm" ${tool.type === 'llm' ? 'selected' : ''}>LLM</option>
            </select>
            <button onclick="removeTool(${i})" style="background: #ef4444; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer;">Remove</button>
          </div>
          <textarea id="config${i}" placeholder='Tool configuration JSON' style="width: 100%; min-height: 120px; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-family: monospace; font-size: 12px;" onchange="try { tools[${i}].config = JSON.parse(this.value); } catch(e) { showToast('Invalid JSON'); }">${JSON.stringify(tool.config, null, 2)}</textarea>
        </div>
      `).join('');
    }
    
    async function createAgent() {
      const name = document.getElementById('agentName').value;
      const maxRetries = parseInt(document.getElementById('maxRetries').value) || 3;
      const timeoutSeconds = parseInt(document.getElementById('timeoutSeconds').value) || 300;
      
      if (!name) return showToast('Agent name required');
      if (tools.length === 0) return showToast('Add at least one tool');
      
      // Validate all tool configs are valid JSON
      for (let i = 0; i < tools.length; i++) {
        const textarea = document.getElementById(`config${i}`);
        if (textarea) {
          try {
            tools[i].config = JSON.parse(textarea.value);
          } catch (e) {
            return showToast(`Invalid JSON in tool ${i + 1}`);
          }
        }
      }
      
      try {
        const isEditing = window.editingAgentId;
        
        if (isEditing) {
          // Update existing agent
          const res = await fetch(`${API_URL}/v1/agents/${window.editingAgentId}`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${apiKey}`
            },
            body: JSON.stringify({ 
              name, 
              steps: tools,
              retry_policy: { max_attempts: maxRetries, backoff: 'exponential' },
              timeout_seconds: timeoutSeconds
            })
          });
          
          if (!res.ok) throw new Error(await res.text());
          
          showToast('Agent updated!', 'success');
          window.editingAgentId = null;
        } else {
          // Create new agent
          const projectsRes = await fetch(`${API_URL}/v1/projects`, {
            headers: { 'Authorization': `Bearer ${apiKey}` }
          });
          const projects = await projectsRes.json();
          
          if (projects.length === 0) return showToast('No project found');
          
          const res = await fetch(`${API_URL}/v1/agents`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${apiKey}`
            },
            body: JSON.stringify({ 
              name, 
              project_id: projects[0].project_id, 
              steps: tools,
              retry_policy: { max_attempts: maxRetries, backoff: 'exponential' },
              timeout_seconds: timeoutSeconds
            })
          });
          
          if (!res.ok) throw new Error(await res.text());
          
          const agent = await res.json();
          
          // Create cron schedule if cron trigger selected
          const triggerType = document.getElementById('triggerType').value;
          if (triggerType === 'cron') {
            const cronExpression = document.getElementById('cronExpression')?.value;
            if (cronExpression) {
              try {
                await fetch(`${API_URL}/v1/schedules`, {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                  },
                  body: JSON.stringify({ 
                    agent_id: agent.agent_id, 
                    project_id: projects[0].project_id, 
                    cron: cronExpression, 
                    input: {} 
                  })
                });
              } catch (schedErr) {
                console.error('Failed to create schedule:', schedErr);
              }
            }
          }
          
          showToast('Agent created!', 'success');
        }
        
        // Clear form
        document.getElementById('agentName').value = '';
        document.getElementById('maxRetries').value = '3';
        document.getElementById('timeoutSeconds').value = '300';
        document.getElementById('triggerType').value = 'cron';
        document.getElementById('triggerInputs').innerHTML = '';
        tools = [];
        renderTools();
        
        loadDashboard();
      } catch (err) {
        showToast('Error: ' + err.message);
      }
    }
    
    async function showRuns() {
      // Clear any existing refresh timer
      if (refreshTimer) {
        clearTimeout(refreshTimer);
        refreshTimer = null;
      }
      
      try {
        const res = await fetch(`${API_URL}/v1/runs`, {
          headers: { 'Authorization': `Bearer ${apiKey}` }
        });
        currentRuns = await res.json();
        
        // Fetch all agents to get names
        const agentsRes = await fetch(`${API_URL}/v1/agents`, {
          headers: { 'Authorization': `Bearer ${apiKey}` }
        });
        const agents = await agentsRes.json();
        const agentMap = {};
        agents.forEach(a => agentMap[a.agent_id] = a.name);
        
        hideAll();
        document.getElementById('runHistory').classList.remove('hidden');
        
        const container = document.getElementById('runsList');
        if (currentRuns.length === 0) {
          container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìä</div><div>No runs yet</div></div>';
          return;
        }
        
        container.innerHTML = currentRuns.map(run => {
          const status = run.status === 'completed' ? 'success' : run.status === 'failed' ? 'error' : 'pending';
          const date = new Date(run.created_at).toLocaleString();
          const agentName = agentMap[run.agent_id] || run.agent_id;
          return `
            <div class="list-item" style="cursor: pointer;" onclick="showRunDetails('${run.run_id}')">
              <div>
                <div class="list-item-title">${agentName}</div>
                <div class="list-item-meta">${date}</div>
              </div>
              <span class="badge badge-${status}">${run.status}</span>
            </div>
          `;
        }).join('');
        
        // Auto-refresh if any runs are pending
        const hasPending = currentRuns.some(r => r.status === 'queued' || r.status === 'running');
        if (hasPending) {
          refreshTimer = setTimeout(showRuns, 2000);
        }
      } catch (err) {
        showToast('Error: ' + err.message);
      }
    }
    
    async function showRunDetails(runId) {
      currentRunId = runId;
      await refreshRunDetails();
    }
    
    async function refreshRunDetails() {
      if (!currentRunId) return;
      
      // Clear any existing refresh timer
      if (refreshTimer) {
        clearTimeout(refreshTimer);
        refreshTimer = null;
      }
      
      try {
        const res = await fetch(`${API_URL}/v1/runs/${currentRunId}`, {
          headers: { 'Authorization': `Bearer ${apiKey}` }
        });
        const run = await res.json();
        
        hideAll();
        document.getElementById('runDetails').classList.remove('hidden');
        
        const status = run.status === 'completed' ? 'success' : run.status === 'failed' ? 'error' : 'pending';
        document.getElementById('detailStatus').innerHTML = `<span class="badge badge-${status}">${run.status}</span>`;
        document.getElementById('detailAgent').textContent = run.agent_id;
        document.getElementById('detailStarted').textContent = new Date(run.created_at).toLocaleString();
        
        const duration = run.completed_at 
          ? Math.round((new Date(run.completed_at) - new Date(run.created_at)) / 1000) + 's'
          : 'Running...';
        document.getElementById('detailDuration').textContent = duration;
        
        // Render step logs
        const logContainer = document.getElementById('detailLog');
        if (run.results && run.results.steps) {
          logContainer.innerHTML = run.results.steps.map((step, i) => {
            const statusColor = step.status === 'success' ? '#10b981' : '#ef4444';
            const icon = step.status === 'success' ? '‚úì' : '‚úó';
            return `
              <div style="margin-bottom: 16px; padding: 12px; background: #2d2d2d; border-radius: 4px; border-left: 3px solid ${statusColor};">
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                  <span style="color: ${statusColor}; font-weight: bold;">${icon} Step ${step.step}: ${step.type}</span>
                  <span style="color: #888;">${step.duration_ms}ms</span>
                </div>
                ${step.error ? `<div style="color: #ef4444; margin-bottom: 8px;">Error: ${step.error}</div>` : ''}
                ${step.output ? `<details style="margin-top: 8px;">
                  <summary style="cursor: pointer; color: #888;">Output</summary>
                  <pre style="margin-top: 8px; color: #d4d4d4;">${JSON.stringify(step.output, null, 2)}</pre>
                </details>` : ''}
              </div>
            `;
          }).join('');
        } else {
          logContainer.textContent = JSON.stringify(run.results || run.result || {}, null, 2);
        }
        
        // Auto-refresh if still running
        if (run.status === 'queued' || run.status === 'running') {
          refreshTimer = setTimeout(refreshRunDetails, 2000);
        }
      } catch (err) {
        showToast('Error: ' + err.message);
      }
    }
    
    function hideAll() {
      // Clear refresh timer when navigating away
      if (refreshTimer) {
        clearTimeout(refreshTimer);
        refreshTimer = null;
      }
      
      document.getElementById('loginScreen').classList.add('hidden');
      document.getElementById('dashboard').classList.add('hidden');
      document.getElementById('agentBuilder').classList.add('hidden');
      document.getElementById('runHistory').classList.add('hidden');
      document.getElementById('runDetails').classList.add('hidden');
      document.getElementById('settings').classList.add('hidden');
    }
    
    function showSettings() {
      hideAll();
      document.getElementById('settings').classList.remove('hidden');
      document.getElementById('workspaceApiKey').value = currentWorkspace?.api_key || '';
      document.getElementById('llmKey').value = currentWorkspace?.llm_api_key || '';
      document.getElementById('sendgridKey').value = currentWorkspace?.sendgrid_api_key || '';
      document.getElementById('twilioSid').value = currentWorkspace?.twilio_account_sid || '';
      document.getElementById('twilioToken').value = currentWorkspace?.twilio_auth_token || '';
    }
    
    function toggleApiKey() {
      const input = document.getElementById('workspaceApiKey');
      const btn = event.target;
      if (input.type === 'password') {
        input.type = 'text';
        btn.textContent = 'Hide';
      } else {
        input.type = 'password';
        btn.textContent = 'Show';
      }
    }
    
    async function saveSettings() {
      const llmKey = document.getElementById('llmKey').value;
      const sendgridKey = document.getElementById('sendgridKey').value;
      const twilioSid = document.getElementById('twilioSid').value;
      const twilioToken = document.getElementById('twilioToken').value;
      
      try {
        const res = await fetch(`${API_URL}/v1/workspace/settings`, {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`
          },
          body: JSON.stringify({ 
            llm_api_key: llmKey, 
            sendgrid_api_key: sendgridKey,
            twilio_account_sid: twilioSid,
            twilio_auth_token: twilioToken
          })
        });
        
        if (!res.ok) throw new Error(await res.text());
        
        showToast('Settings saved!', 'success');
        currentWorkspace.llm_api_key = llmKey;
        currentWorkspace.sendgrid_api_key = sendgridKey;
        currentWorkspace.twilio_account_sid = twilioSid;
        currentWorkspace.twilio_auth_token = twilioToken;
      } catch (err) {
        showToast('Error: ' + err.message);
      }
    }
    
    function showDashboard() {
      loadDashboard();
    }
    
    function showDocs() {
      window.location.href = '/docs.html';
    }
    
    // Auto-login if API key exists
    if (apiKey) {
      loadDashboard();
    } else {
      document.getElementById('loginScreen').classList.remove('hidden');
    }
  </script>
</body>
</html>
